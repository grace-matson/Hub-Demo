name: automation

on:
  workflow_dispatch:

concurrency:
  group: test

jobs:
  main_bucket:
    runs-on: new-runner
    steps:
      - uses: actions/checkout@v2
      - name: Copy file to gcs bucket
        run: gsutil -m rsync -r ./testdir gs://demo-automate-hub-release-test-master/
    
  matrix_regional_buckets:
    runs-on: new-runner  
    needs: main_bucket
    strategy:
      fail-fast: false
      matrix:
        loc: ["dir 1"]
        # loc: [ "dir1" , "dir2", "dir3", "dir4","dir5", "dir6", "dir7", "dir8", "dir9"]
    steps:
      - name: Syncing buckets, max 3 retries
        uses: nick-fields/retry@v2
        with:
          timeout_seconds: 15
          max_attempts: 3
          retry_on: error
          on_retry_command: echo "The upload to ${{matrix.loc}} has failed"
          command: gsutil -m rsync -r gs://demo-automate-hub-release-test-master/ gs://demo-automate-hub-release-test-${{ matrix.loc }}/

  failure_mode:
    runs-on: new-runner  
    if: ${{ always() && contains(join(needs.*.result, ','), 'failure') }}
    needs: matrix_regional_buckets
    steps:
      - name: Revert changes checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Last successful commit ID
        uses: SamhammerAG/last-successful-build-action@v2
        id: last_successful_commit
        with:
          token: ${{ github.token }}
          branch: "main"
          workflow: "automation"
          verify: true

      - name: Commit hash
        run: |
          echo "Last commit before current run: ${{github.sha}}"
          echo "Last successful commit: ${{ steps.last_successful_commit.outputs.sha }}"

      - name: Failure, sending email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{secrets.MAIL_USERNAME}}
          password: ${{secrets.MAIL_PASSWORD}}
          subject: Failure of Github workflow run in ${{github.repository}}
          to: gracematson@google.com
          from: HUB DEMO OFFICIAL 
          secure: true
          body: |
              Repository : ${{github.repository}}
              Workflow : ${{ github.workflow	}}
              Run : ${{github.run_id}}
              Last commit before failed workflow execution : ${{github.sha}}
              Last commit before successful workflow : ${{ steps.last_successful_commit.outputs.sha }}


      - name: Revert changes
        run: |
          git config user.name grace-matson
          git config user.email gracematson@google.com
          git reset ${{ steps.last_successful_commit.outputs.sha }}
          git add .
          git commit -m "Trying to revert to ${{ steps.last_successful_commit.outputs.sha }}""

      - name: Create Pull Request for Revert
        uses: peter-evans/create-pull-request@v3.10.0
        with:
          token: ${{ github.token }}
          title: 'Automated PR'
          body: |
            This PR is to revert from commit ${{github.sha}} to ${{ steps.last_successful_commit.outputs.sha }} 
            because workflow ${{ github.workflow	}} failed on run ${{github.run_id}}
          branch: revert
      
  
